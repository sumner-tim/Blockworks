WITH
-- 1. Retrieve cbETH peg rate data and event time
cbeth_evt AS (
    SELECT
        evt_block_time AS time,
        cast(newExchangeRate as double) / 1e18 AS eth_cbeth_peg
    FROM coinbase_ethereum.StakedTokenV1_evt_ExchangeRateUpdated
    WHERE evt_block_time >= cast('2022-07-15 00:00' as timestamp)
    ORDER BY time ASC
),

-- 2. Calculate APY for cbETH based on the peg rate changes over time
cbeth AS (
    SELECT
        time,
        100 * 365 * ((eth_cbeth_peg / NULLIF(coalesce(lag(eth_cbeth_peg) OVER (ORDER BY time), 0), 0) - 1)) AS apy
    FROM cbeth_evt
),

-- 3. Rank APY values and assign row numbers for trimming
cbeth_ranked AS (
    SELECT
        time,
        apy,
        ROW_NUMBER() OVER (ORDER BY apy ASC) AS row_asc,
        ROW_NUMBER() OVER (ORDER BY apy DESC) AS row_desc,
        COUNT(*) OVER () AS total_rows
    FROM cbeth
),

-- 4. Filter out top and bottom 10% APY values based on row numbers
cbeth_trimmed AS (
    SELECT
        time,
        apy
    FROM cbeth_ranked
    WHERE row_asc > 0.1 * total_rows
      AND row_desc > 0.1 * total_rows
),

-- 5. Calculate the 10% trimmed average of the remaining APY values
cbeth_trimmed_avg AS (
    SELECT
        AVG(apy) AS "cbETH 10% Trimmed Average APY"
    FROM cbeth_trimmed
)

-- 6. Output the final result
SELECT
    "cbETH 10% Trimmed Average APY"
FROM cbeth_trimmed_avg
